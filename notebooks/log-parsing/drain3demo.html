
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IBM Drain3 Demo &#8212; Data Science Workflows</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet" />
  <link href="../../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Data Science Workflows</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../README.html">
   Data Science Workflows
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  Getting started
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../docs/getting-started.html">
   Getting Started
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../docs/how-to-contribute.html">
   How to Contribute
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  AIOps projects
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../docs/aiops-projects.html">
   AI Ops Projects
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../docs/project-document-template.html">
   Project Outline Template
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../docs/project-structure.html">
   Data Science Projects Structure for AI Ops
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  Best Practices and Guidelines
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../docs/guidelines-for-reviewing-datascience-code.html">
   10 Principles for Reviewing Data Science Code
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../docs/data-visualization-best-practices.html">
   Best Practices for Data Science Visualizations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../docs/create_and_deploy_jh_image.html">
   How to create a JupyterHub image and deploy it on ODH
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../_sources/notebooks/log-parsing/drain3demo.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/aicoe-aiops/data-science-workflows"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/aicoe-aiops/data-science-workflows/issues/new?title=Issue%20on%20page%20%2Fnotebooks/log-parsing/drain3demo.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href=" /v2/gh/aicoe-aiops/data-science-workflows/master?urlpath=lab/tree/notebooks/log-parsing/drain3demo.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        <a class="jupyterhub-button" href="https://jupyterhub-opf-jupyterhub.apps.smaug.na.operate-first.cloud/hub/user-redirect/git-pull?repo=https://github.com/aicoe-aiops/data-science-workflows&urlpath=lab/tree/data-science-workflows/notebooks/log-parsing/drain3demo.ipynb&branch=master"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch JupyterHub" data-toggle="tooltip"
                data-placement="left"><img class="jupyterhub-button-logo"
                    src="../../_static/images/logo_jupyterhub.svg"
                    alt="Interact on JupyterHub">JupyterHub</button></a>
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#perform-template-mining-with-default-configuration">
   Perform Template Mining with Default Configuration
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#perform-template-mining-with-custom-configurations">
   Perform Template Mining with Custom Configurations
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#masking-config">
     Masking Config
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#drain3-config">
     Drain3 Config
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#match-new-logs-to-mined-templates-inference">
   Match New Logs to Mined Templates (Inference)
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="ibm-drain3-demo">
<h1>IBM Drain3 Demo<a class="headerlink" href="#ibm-drain3-demo" title="Permalink to this headline">¶</a></h1>
<p>Logs are an effective source of data to understand system health and behavior. However, they can often be long and noisy, which makes it difficult for a human to manually analyze them.</p>
<p>In 2017, the <a class="reference external" href="https://github.com/logpai">LogPAI</a> team developed an online log parsing algorithm called <a class="reference external" href="https://github.com/logpai/logparser/blob/e8d96cd4de1121c5d2b517982c6028cd06e643f1/docs/tools/Drain.md">Drain</a>, that parses logs to extract “log templates” from them. Using these log templates instead of raw logs makes it much easier and faster to analyze log data. The IBM research team then upgraded the official implementation of this project, added some new features and bugfixes, and wrapped it into a python package called <a class="reference external" href="https://github.com/IBM/Drain3">drain3</a>.</p>
<p>In this notebook, we will demonstrate how you can use the IBM drain3 library can be to extract log templates from raw logs data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">drain3</span> <span class="kn">import</span> <span class="n">TemplateMiner</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># download sample log file</span>
<span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://raw.githubusercontent.com/logpai/loghub/master/Apache/Apache_2k.log&#39;</span>
<span class="n">ret</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">ret</span><span class="o">.</span><span class="n">status_code</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>200
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># read the log file and convert to list of log lines</span>
<span class="n">log_file</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
<span class="n">log_lines</span> <span class="o">=</span> <span class="n">log_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># split into two sets for &quot;training&quot; and &quot;testing&quot;</span>
<span class="n">train_lines</span> <span class="o">=</span> <span class="n">log_lines</span><span class="p">[:</span><span class="mi">1900</span><span class="p">]</span>
<span class="n">test_lines</span> <span class="o">=</span> <span class="n">log_lines</span><span class="p">[</span><span class="o">-</span><span class="mi">100</span><span class="p">:]</span>

<span class="c1"># how many lines in the log file</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;There are </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">log_lines</span><span class="p">)</span><span class="si">}</span><span class="s1"> lines in the log file. Some of them are:&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># peek at the first 10 lines in the log</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_lines</span><span class="p">[:</span><span class="mi">10</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>There are 2000 lines in the log file. Some of them are:

[Sun Dec 04 04:47:44 2005] [notice] workerEnv.init() ok /etc/httpd/conf/workers2.properties
[Sun Dec 04 04:47:44 2005] [error] mod_jk child workerEnv in error state 6
[Sun Dec 04 04:51:08 2005] [notice] jk2_init() Found child 6725 in scoreboard slot 10
[Sun Dec 04 04:51:09 2005] [notice] jk2_init() Found child 6726 in scoreboard slot 8
[Sun Dec 04 04:51:09 2005] [notice] jk2_init() Found child 6728 in scoreboard slot 6
[Sun Dec 04 04:51:14 2005] [notice] workerEnv.init() ok /etc/httpd/conf/workers2.properties
[Sun Dec 04 04:51:14 2005] [notice] workerEnv.init() ok /etc/httpd/conf/workers2.properties
[Sun Dec 04 04:51:14 2005] [notice] workerEnv.init() ok /etc/httpd/conf/workers2.properties
[Sun Dec 04 04:51:18 2005] [error] mod_jk child workerEnv in error state 6
[Sun Dec 04 04:51:18 2005] [error] mod_jk child workerEnv in error state 6
</pre></div>
</div>
</div>
</div>
<div class="section" id="perform-template-mining-with-default-configuration">
<h2>Perform Template Mining with Default Configuration<a class="headerlink" href="#perform-template-mining-with-default-configuration" title="Permalink to this headline">¶</a></h2>
<p>In this section, we will use drain to mine the log templates from the first 1900 line of the log file.</p>
<p>The drain <a class="reference external" href="http://jiemingzhu.github.io/pub/pjhe_icws2017.pdf">research paper</a> as well as the IBM drain3 repo <a class="reference external" href="https://github.com/IBM/Drain3#configuration">readme</a> explains the parameters that the drain log parser can be configured with. In this section, we will simply run it with the default parameters. And try to find the log templates that exist in our sample log file.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># init drain3 template miner and view config</span>
<span class="n">miner</span> <span class="o">=</span> <span class="n">TemplateMiner</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Drain3 config:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="n">miner</span><span class="o">.</span><span class="n">config</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Drain3 config:

profiling_enabled = False
profiling_report_sec = 60
snapshot_interval_minutes = 5
snapshot_compress_state = True
drain_extra_delimiters = []
drain_sim_th = 0.4
drain_depth = 4
drain_max_children = 100
drain_max_clusters = None
masking_instructions = []
mask_prefix = &lt;
mask_suffix = &gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># mine templates</span>
<span class="c1"># notice that the lines are added one by one, as a &quot;stream&quot;</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">train_lines</span><span class="p">:</span>
    <span class="n">miner_result</span> <span class="o">=</span> <span class="n">miner</span><span class="o">.</span><span class="n">add_log_message</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># what are templates mined in this logfile</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">miner</span><span class="o">.</span><span class="n">drain</span><span class="o">.</span><span class="n">clusters</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ID=1     : size=298       : [Sun Dec 04 &lt;*&gt; 2005] [notice] workerEnv.init() ok /etc/httpd/conf/workers2.properties

ID=2     : size=281       : [Sun Dec 04 &lt;*&gt; 2005] [error] mod_jk child workerEnv in error state &lt;*&gt;

ID=3     : size=442       : [Sun Dec 04 &lt;*&gt; 2005] [notice] jk2_init() Found child &lt;*&gt; in scoreboard slot &lt;*&gt;

ID=4     : size=18        : [Sun Dec 04 &lt;*&gt; 2005] [error] [client &lt;*&gt; Directory index forbidden by rule: /var/www/html/

ID=5     : size=6         : [Sun Dec 04 &lt;*&gt; 2005] [error] jk2_init() Can&#39;t find child &lt;*&gt; in scoreboard

ID=6     : size=6         : [Sun Dec 04 &lt;*&gt; 2005] [error] mod_jk child init 1 -2

ID=7     : size=12        : [Mon Dec 05 &lt;*&gt; 2005] [error] [client &lt;*&gt; Directory index forbidden by rule: /var/www/html/

ID=8     : size=360       : [Mon Dec 05 &lt;*&gt; 2005] [notice] jk2_init() Found child &lt;*&gt; in scoreboard slot &lt;*&gt;

ID=9     : size=239       : [Mon Dec 05 &lt;*&gt; 2005] [notice] workerEnv.init() ok /etc/httpd/conf/workers2.properties

ID=10    : size=226       : [Mon Dec 05 &lt;*&gt; 2005] [error] mod_jk child workerEnv in error state &lt;*&gt;

ID=11    : size=6         : [Mon Dec 05 &lt;*&gt; 2005] [error] jk2_init() Can&#39;t find child &lt;*&gt; in scoreboard

ID=12    : size=6         : [Mon Dec 05 &lt;*&gt; 2005] [error] mod_jk child init 1 -2
</pre></div>
</div>
</div>
</div>
<p><strong>RESULT</strong> From the above output, we can see that drain has learned 12 templates from the log. That is, there are only 12 unique general “structures” or “types” of log lines in our file. So to understand the system behavior, we can simply look at these 12 templates instead of looking at 2000 raw log lines. In this way, drain can significantly reduce the time and effort spent in log file analysis.</p>
<p>However, we can see that it could not identify the timestamps at the beginning of each log line as template wildcard items. So in the next sections, we will try to explore how we can update the configuration to further improve template mining.</p>
</div>
<div class="section" id="perform-template-mining-with-custom-configurations">
<h2>Perform Template Mining with Custom Configurations<a class="headerlink" href="#perform-template-mining-with-custom-configurations" title="Permalink to this headline">¶</a></h2>
<div class="section" id="masking-config">
<h3>Masking Config<a class="headerlink" href="#masking-config" title="Permalink to this headline">¶</a></h3>
<p>In this section, we’ll run drain with a custom “masking” parameter. Since we know what the timestamps look like, we can add a regex to “mask” the timestamps so that they do not count as a part of the template learning.</p>
<p>To do that, we will create a <code class="docutils literal notranslate"><span class="pre">drain3.ini</span></code> file in the working directory with the following section in it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">MASKING</span><span class="p">]</span>
<span class="n">masking</span> <span class="o">=</span> <span class="p">[</span>
          <span class="p">{</span><span class="s2">&quot;regex_pattern&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">[(.*?)2005</span><span class="se">\\</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="s2">&quot;mask_with&quot;</span><span class="p">:</span> <span class="s2">&quot;TIMESTAMP&quot;</span><span class="p">}</span>
          <span class="p">]</span>
</pre></div>
</div>
<p>Notice that here we’re just adding one custom regex, but in general you can add a list of regex’es to mask known patterns in log files, as shown in the example <a class="reference external" href="https://github.com/IBM/Drain3/blob/15470e391caed9a9ef5038cdd1dbd373bd2386a8/examples/drain3.ini">here</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># init drain3 template miner with new masking config</span>
<span class="n">miner</span> <span class="o">=</span> <span class="n">TemplateMiner</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Drain3 config:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="n">miner</span><span class="o">.</span><span class="n">config</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Drain3 config:

profiling_enabled = False
profiling_report_sec = 60
snapshot_interval_minutes = 5
snapshot_compress_state = True
drain_extra_delimiters = []
drain_sim_th = 0.4
drain_depth = 4
drain_max_children = 100
drain_max_clusters = None
masking_instructions = [&lt;drain3.masking.MaskingInstruction object at 0x7fe3af09be48&gt;]
mask_prefix = &lt;
mask_suffix = &gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># mine templates</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">train_lines</span><span class="p">:</span>
    <span class="n">miner_result</span> <span class="o">=</span> <span class="n">miner</span><span class="o">.</span><span class="n">add_log_message</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># what are templates mined in this logfile</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">miner</span><span class="o">.</span><span class="n">drain</span><span class="o">.</span><span class="n">clusters</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ID=1     : size=537       : &lt;TIMESTAMP&gt; [notice] workerEnv.init() ok /etc/httpd/conf/workers2.properties

ID=2     : size=507       : &lt;TIMESTAMP&gt; [error] mod_jk child workerEnv in error state &lt;*&gt;

ID=3     : size=802       : &lt;TIMESTAMP&gt; [notice] jk2_init() Found child &lt;*&gt; in scoreboard slot &lt;*&gt;

ID=4     : size=30        : &lt;TIMESTAMP&gt; [error] [client &lt;*&gt; Directory index forbidden by rule: /var/www/html/

ID=5     : size=12        : &lt;TIMESTAMP&gt; [error] jk2_init() Can&#39;t find child &lt;*&gt; in scoreboard

ID=6     : size=12        : &lt;TIMESTAMP&gt; [error] mod_jk child init 1 -2
</pre></div>
</div>
</div>
</div>
<p><strong>RESULT</strong> Great, with the new masking config we were able to generalize the log templates even more. That is, the previous separate templates such as <code class="docutils literal notranslate"><span class="pre">[Mon</span> <span class="pre">Dec</span> <span class="pre">05</span> <span class="pre">&lt;*&gt;</span> <span class="pre">2005]</span> <span class="pre">[error]</span> <span class="pre">mod_jk</span> <span class="pre">child</span> <span class="pre">init</span> <span class="pre">1</span> <span class="pre">-2</span></code> and <code class="docutils literal notranslate"><span class="pre">[Sun</span> <span class="pre">Dec</span> <span class="pre">04</span> <span class="pre">&lt;*&gt;</span> <span class="pre">2005]</span> <span class="pre">[error]</span> <span class="pre">mod_jk</span> <span class="pre">child</span> <span class="pre">init</span> <span class="pre">1</span> <span class="pre">-2</span></code>, that differed in just the timestamps, now got clubbed as one single template, <code class="docutils literal notranslate"><span class="pre">[Sun</span> <span class="pre">Dec</span> <span class="pre">04</span> <span class="pre">&lt;*&gt;</span> <span class="pre">2005]</span> <span class="pre">[error]</span> <span class="pre">mod_jk</span> <span class="pre">child</span> <span class="pre">init</span> <span class="pre">1</span> <span class="pre">-2</span></code>.</p>
<p>Thus, now instead of looking at 2000 log lines, we only need to look at 6 log lines to understand system behavior characterized by this log file.</p>
</div>
<div class="section" id="drain3-config">
<h3>Drain3 Config<a class="headerlink" href="#drain3-config" title="Permalink to this headline">¶</a></h3>
<p>In this section, we’ll run drain with a custom “drain3” parameter called <code class="docutils literal notranslate"><span class="pre">similarity</span> <span class="pre">threshold</span></code>. This parameter dictates how similar a log line has to be to a given template, to be considered as belonging to the same template.</p>
<p>To do that, we will add the following section to our <code class="docutils literal notranslate"><span class="pre">drain3.ini</span></code> file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">DRAIN</span><span class="p">]</span>
<span class="n">sim_th</span> <span class="o">=</span> <span class="mf">0.2</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># init drain3 template miner with added drain3 parameter</span>
<span class="n">miner</span> <span class="o">=</span> <span class="n">TemplateMiner</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Drain3 config:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="n">miner</span><span class="o">.</span><span class="n">config</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Drain3 config:

profiling_enabled = False
profiling_report_sec = 60
snapshot_interval_minutes = 5
snapshot_compress_state = True
drain_extra_delimiters = []
drain_sim_th = 0.2
drain_depth = 4
drain_max_children = 100
drain_max_clusters = None
masking_instructions = [&lt;drain3.masking.MaskingInstruction object at 0x7fe3af4c4da0&gt;]
mask_prefix = &lt;
mask_suffix = &gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># mine templates</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">train_lines</span><span class="p">:</span>
    <span class="n">miner_result</span> <span class="o">=</span> <span class="n">miner</span><span class="o">.</span><span class="n">add_log_message</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># what are templates mined in this logfile</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">miner</span><span class="o">.</span><span class="n">drain</span><span class="o">.</span><span class="n">clusters</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ID=1     : size=537       : &lt;TIMESTAMP&gt; [notice] workerEnv.init() ok /etc/httpd/conf/workers2.properties

ID=2     : size=519       : &lt;TIMESTAMP&gt; [error] &lt;*&gt; &lt;*&gt; &lt;*&gt; &lt;*&gt; &lt;*&gt; &lt;*&gt; &lt;*&gt;

ID=3     : size=802       : &lt;TIMESTAMP&gt; [notice] jk2_init() Found child &lt;*&gt; in scoreboard slot &lt;*&gt;

ID=4     : size=30        : &lt;TIMESTAMP&gt; [error] [client &lt;*&gt; Directory index forbidden by rule: /var/www/html/

ID=5     : size=12        : &lt;TIMESTAMP&gt; [error] mod_jk child init 1 -2
</pre></div>
</div>
</div>
</div>
<p><strong>RESULT</strong> As we can see, setting the similarity threshold to a low value resulted in merging of two distinct log templates into one. Thus, arbitrarily updating the similarity threshold without properly understanding the domain can yield worse results.</p>
<p>The default drain parameters are set based on the research authors’ experiments, so they should generally work fine, but can also be tuned for optimal performance as shown in the above two sections.</p>
</div>
</div>
<div class="section" id="match-new-logs-to-mined-templates-inference">
<h2>Match New Logs to Mined Templates (Inference)<a class="headerlink" href="#match-new-logs-to-mined-templates-inference" title="Permalink to this headline">¶</a></h2>
<p>In the previous sections, we used the first 1900 lines in our logfile to mine the templates. Now we will use the last 100 lines to run inference. That is, we will match / bucket each unseen log line to one of the learned log templates.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># assign templates to new log lines</span>
<span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">test_lines</span><span class="p">:</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">miner</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>

<span class="n">num_egs_to_display</span> <span class="o">=</span> <span class="mi">10</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">log_lines</span><span class="p">[</span><span class="o">-</span><span class="mi">100</span><span class="p">:],</span> <span class="n">results</span><span class="p">)):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">get_template</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">num_egs_to_display</span><span class="p">:</span>
        <span class="k">break</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[Mon Dec 05 17:40:38 2005] [notice] jk2_init() Found child 6577 in scoreboard slot 7
&lt;TIMESTAMP&gt; [notice] jk2_init() Found child &lt;*&gt; in scoreboard slot &lt;*&gt;

[Mon Dec 05 17:40:38 2005] [notice] jk2_init() Found child 6578 in scoreboard slot 8
&lt;TIMESTAMP&gt; [notice] jk2_init() Found child &lt;*&gt; in scoreboard slot &lt;*&gt;

[Mon Dec 05 17:40:39 2005] [notice] workerEnv.init() ok /etc/httpd/conf/workers2.properties
&lt;TIMESTAMP&gt; [notice] workerEnv.init() ok /etc/httpd/conf/workers2.properties

[Mon Dec 05 17:40:39 2005] [error] mod_jk child workerEnv in error state 6
&lt;TIMESTAMP&gt; [error] mod_jk child workerEnv in error state &lt;*&gt;

[Mon Dec 05 17:40:39 2005] [notice] workerEnv.init() ok /etc/httpd/conf/workers2.properties
&lt;TIMESTAMP&gt; [notice] workerEnv.init() ok /etc/httpd/conf/workers2.properties

[Mon Dec 05 17:40:39 2005] [error] mod_jk child workerEnv in error state 6
&lt;TIMESTAMP&gt; [error] mod_jk child workerEnv in error state &lt;*&gt;

[Mon Dec 05 17:46:02 2005] [notice] jk2_init() Found child 6585 in scoreboard slot 7
&lt;TIMESTAMP&gt; [notice] jk2_init() Found child &lt;*&gt; in scoreboard slot &lt;*&gt;

[Mon Dec 05 17:46:02 2005] [notice] jk2_init() Found child 6586 in scoreboard slot 8
&lt;TIMESTAMP&gt; [notice] jk2_init() Found child &lt;*&gt; in scoreboard slot &lt;*&gt;

[Mon Dec 05 17:46:06 2005] [notice] workerEnv.init() ok /etc/httpd/conf/workers2.properties
&lt;TIMESTAMP&gt; [notice] workerEnv.init() ok /etc/httpd/conf/workers2.properties

[Mon Dec 05 17:46:06 2005] [notice] workerEnv.init() ok /etc/httpd/conf/workers2.properties
&lt;TIMESTAMP&gt; [notice] workerEnv.init() ok /etc/httpd/conf/workers2.properties

[Mon Dec 05 17:46:06 2005] [error] mod_jk child workerEnv in error state 6
&lt;TIMESTAMP&gt; [error] mod_jk child workerEnv in error state &lt;*&gt;

[Mon Dec 05 17:46:06 2005] [error] mod_jk child workerEnv in error state 6
&lt;TIMESTAMP&gt; [error] mod_jk child workerEnv in error state &lt;*&gt;
</pre></div>
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "drain3demo"
        },
        kernelOptions: {
            kernelName: "drain3demo",
            path: "./notebooks/log-parsing"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'drain3demo'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    

</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By AIOps<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>