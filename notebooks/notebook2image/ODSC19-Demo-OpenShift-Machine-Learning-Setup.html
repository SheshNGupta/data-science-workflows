
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Setup for s2i notebook deployment on OpenShift &#8212; Data Science Workflows</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet" />
  <link href="../../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Data Science Workflows</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../README.html">
   Data Science Workflows
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  Getting started
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../docs/getting-started.html">
   Getting Started
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../docs/how-to-contribute.html">
   How to Contribute
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  AIOps projects
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../docs/aiops-projects.html">
   AI Ops Projects
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../docs/project-document-template.html">
   Project Outline Template
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../docs/project-structure.html">
   Data Science Projects Structure for AI Ops
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  Best Practices and Guidelines
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../docs/guidelines-for-reviewing-datascience-code.html">
   10 Principles for Reviewing Data Science Code
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../docs/data-visualization-best-practices.html">
   Best Practices for Data Science Visualizations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../docs/create_and_deploy_jh_image.html">
   How to create a JupyterHub image and deploy it on ODH
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../_sources/notebooks/notebook2image/ODSC19-Demo-OpenShift-Machine-Learning-Setup.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/aicoe-aiops/data-science-workflows"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/aicoe-aiops/data-science-workflows/issues/new?title=Issue%20on%20page%20%2Fnotebooks/notebook2image/ODSC19-Demo-OpenShift-Machine-Learning-Setup.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href=" /v2/gh/aicoe-aiops/data-science-workflows/master?urlpath=lab/tree/notebooks/notebook2image/ODSC19-Demo-OpenShift-Machine-Learning-Setup.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        <a class="jupyterhub-button" href="https://jupyterhub-opf-jupyterhub.apps.smaug.na.operate-first.cloud/hub/user-redirect/git-pull?repo=https://github.com/aicoe-aiops/data-science-workflows&urlpath=lab/tree/data-science-workflows/notebooks/notebook2image/ODSC19-Demo-OpenShift-Machine-Learning-Setup.ipynb&branch=master"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch JupyterHub" data-toggle="tooltip"
                data-placement="left"><img class="jupyterhub-button-logo"
                    src="../../_static/images/logo_jupyterhub.svg"
                    alt="Interact on JupyterHub">JupyterHub</button></a>
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#access-to-openshift">
   Access to OpenShift
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#install-oc-client">
   Install oc client
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#oc-commands-to-login-check-your-connection-to-openshift-and-select-your-project">
   oc commands to login, check your connection to OpenShift and select your project
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#clone-the-correct-repo-into-your-local-environment-or-jupyter-hub">
   Clone the correct repo into your local environment or jupyter hub
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#set-environment-variables-as-secrets">
   Set Environment Variables as Secrets
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#build-notebook-image-and-launch-service">
   Build notebook image and launch service
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#expose-service-for-interaction-with-inference-engine">
   Expose service for interaction with inference engine
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#interact-with-model">
   Interact with model
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="setup-for-s2i-notebook-deployment-on-openshift">
<h1>Setup for s2i notebook deployment on OpenShift<a class="headerlink" href="#setup-for-s2i-notebook-deployment-on-openshift" title="Permalink to this headline">¶</a></h1>
<p>This notebook outlines the necessary steps and command line arguments that a user would need to deploy their machine learning notebooks as a flask app on OpenShift. It will cover the following:</p>
<ul class="simple">
<li><p>Access to OpenShift</p></li>
<li><p>Install oc client</p></li>
<li><p>Git clone a repo</p></li>
<li><p>Set env Variables</p></li>
<li><p>Deploy new app</p></li>
<li><p>Expose it as a service</p></li>
<li><p>Interact with the service</p></li>
</ul>
<div class="section" id="access-to-openshift">
<h2>Access to OpenShift<a class="headerlink" href="#access-to-openshift" title="Permalink to this headline">¶</a></h2>
<p>If you don’t already have access to OpenShift you can go to <a class="reference external" href="https://www.okd.io/">https://www.okd.io/</a> and try it out yourself or sign up for a free account with OpenShift online (<a class="reference external" href="https://www.openshift.com/products/online/">https://www.openshift.com/products/online/</a>)</p>
<p>Once you have access to OpenShift you are going to want to use the oc client on your local machine or in a jupyter hub terminal to interact with it.</p>
</div>
<div class="section" id="install-oc-client">
<h2>Install oc client<a class="headerlink" href="#install-oc-client" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">bash</span> 
curl -o oc.tar.gz -L https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux-4.1.0-rc.0.tar.gz 
tar xzf oc.tar.gz 
cp oc ~/../bin/oc
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="oc-commands-to-login-check-your-connection-to-openshift-and-select-your-project">
<h2>oc commands to login, check your connection to OpenShift and select your project<a class="headerlink" href="#oc-commands-to-login-check-your-connection-to-openshift-and-select-your-project" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span> oc login hostname -u user-name -p password
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span> oc whoami
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span> oc project your-project-name
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="clone-the-correct-repo-into-your-local-environment-or-jupyter-hub">
<h2>Clone the correct repo into your local environment or jupyter hub<a class="headerlink" href="#clone-the-correct-repo-into-your-local-environment-or-jupyter-hub" title="Permalink to this headline">¶</a></h2>
<p>In this example we will be using one of my repos: <a class="reference external" href="https://github.com/MichaelClifford/example-model-s2i-notebook">https://github.com/MichaelClifford/example-model-s2i-notebook</a></p>
<p>However, it is important to note that any repo that follows the same simple conventions can be used.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span> git clone https://github.com/MichaelClifford/example-model-s2i-notebook
</pre></div>
</div>
</div>
</div>
<p>Once the user has made the appropriate changes to their notebook they can push it back to github for the s2i builder.</p>
</div>
<div class="section" id="set-environment-variables-as-secrets">
<h2>Set Environment Variables as Secrets<a class="headerlink" href="#set-environment-variables-as-secrets" title="Permalink to this headline">¶</a></h2>
<p>Any environment variables needed for the notebook to execute such as s3 bucket credentials can be configured as <a class="reference external" href="https://docs.openshift.com/container-platform/3.11/dev_guide/secrets.html">Secrets</a> in OpenShift. Using the web console, by navigating to Resources and Secrets, we can create “Generic” Secret types for the environment variable, set a “Secret Name”, specify the name of the key referenced in the notebook as “Key” and the value of the environment variable as “Value”.</p>
<p>After launching the service, we can add these Secrets to the Build Environment Variables and selecting “Add Value from Config Map or Secret”. We can let the initial build fail and upon triggering a “Rebuild”, the secrets will be used.</p>
</div>
<div class="section" id="build-notebook-image-and-launch-service">
<h2>Build notebook image and launch service<a class="headerlink" href="#build-notebook-image-and-launch-service" title="Permalink to this headline">¶</a></h2>
<p>On OpenShift, with this simple command below we can invoke a special image builder for notebooks and provided it a github repository containing a machine learning notebook with data collection, processing, training and inference and build an image and deploy it directly as an inference service running a flask application in a pod.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">bash</span>
oc new-app --name model \
quay.io/willbenton/simple-model-s2i:demo\
~https://github.com/MichaelClifford/example-model-s2i-notebook
</pre></div>
</div>
</div>
</div>
<p>When building from a private Git repo, we need to follow some additional steps. We can use deploy keys to authenticate the private Git repository.
By following the steps outlined <a class="reference external" href="https://www.openshift.com/blog/private-git-repositories-part-2a-repository-ssh-keys">here</a>, we can generate an ssh key to be used with the repository. We need to add the Public key (the .pub file) that we generated to the Github Repo by going to the repo settings under “Add deploy key”.</p>
<p>The private key can be added as a Source Secret on OpenShift the same way we added environment variables. For adding the private ssh key, we can create a new Source Secret and select authentication type as “SSH Key”, specify a secret name and paste the private key that we generated in the Private SSH Key section.</p>
<p>Once we have set up the Secret, we can run the <code class="docutils literal notranslate"><span class="pre">new-app</span></code> command with the ssh url of the repo and specify the –source-secret parameter.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">bash</span>
oc new-app --name model \
quay.io/willbenton/simple-model-s2i:demo\
~git@github.com:MichaelClifford/example-model-s2i-notebook.git \
--source-secret secretname
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="expose-service-for-interaction-with-inference-engine">
<h2>Expose service for interaction with inference engine<a class="headerlink" href="#expose-service-for-interaction-with-inference-engine" title="Permalink to this headline">¶</a></h2>
<p>Finally, just so it can be used by others we need to expose the route of our service so that it can be accessed by other users with the following command.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span> oc expose svc/model 
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="interact-with-model">
<h2>Interact with model<a class="headerlink" href="#interact-with-model" title="Permalink to this headline">¶</a></h2>
<p>This basic code snippet can then be used to interact with the flask app, or if you prefer you could use your favorite REST tool like Insomnia (<a class="reference external" href="https://insomnia.rest/">https://insomnia.rest/</a>)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">cloudpickle</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">baseurl</span> <span class="o">=</span> <span class="s2">&quot;your-models-route&quot;</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">29</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">cloudpickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">args</span><span class="p">))}</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">baseurl</span> <span class="o">+</span> <span class="s2">&quot;/predict&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot; input is class&quot;</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./notebooks/notebook2image"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    

</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By AIOps<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>